{% extends "main.html" %}

{% block add_includes %}
    <link rel="stylesheet" href="{{ static_url("js/fancybox/source/jquery.fancybox.css") }}" type="text/css" media="screen" />
    <script type="text/javascript" src="{{ static_url("js/fancybox/source/jquery.fancybox.pack.js") }}" ></script>
    <!-- AmCharts -->
    <script src="{{ static_url("js/amcharts/amcharts.js") }}"></script>
    <script src="{{ static_url("js/amcharts/serial.js") }}"></script>

    <script type="text/javascript">
      var tbl_data;
      var tbl_spark;

      var val_corrisotope;
      var val_corrimages;
      var val_maxent;

      function set_filter() {
        if ($('#useMinCorrIsotope').is(':checked')) {
          val_corrisotope = parseFloat($('#minCorrIsotope').val());
        } else {
          val_corrisotope = -1;
        }
        if ($('#useMinCorrImages').is(':checked')) {
          val_corrimages = parseFloat($('#minCorrImages').val());
        } else {
          val_corrimages = -1;
        }
        if ($('#useMaxEntropy').is(':checked')) {
          val_maxent = parseFloat($('#maxEntropy').val());
        } else {
          val_maxent = 100000;
        }
      }

      function filter_row(row) {
        return (row[4] <= val_maxent && row[5] >= val_corrimages && row[6] >= val_corrisotope);
      }
    </script>
{% end %}

{% block init_script %}
    <script type="text/javascript" class="init">
      $(document).ready(function() {
        var job_id = window.location.pathname.split('/')[window.location.pathname.split('/').length-1];
        $.getJSON("/ajax/jobdescription/" + job_id + "/", function (data) {
          $("#about-name").text( data["description"] );
          $("#about-dataset").text( data["dataset"] );
        });

        function cb_maxent() {
            $("#maxEntropy").prop("disabled", !this.checked);
        }
        function cb_mincorr() {
            $("#minCorrImages").prop("disabled", !this.checked);
        }
        function cb_miniso() {
            $("#minCorrIsotope").prop("disabled", !this.checked);
        }

        $("#useMaxEntropy").click(cb_maxent);
        $("#useMinCorrImages").click(cb_mincorr);
        $("#useMinCorrIsotope").click(cb_miniso);

        $.getJSON("/ajax/fullimages/" + job_id + "/", function (data) {
          tbl_data = data["data"];
          // alert(tbl_data[0]);
          set_filter();
          tbl_spark = $('#table-images').DataTable( {
            data: tbl_data.filter(filter_row),
            order: [[ 4, "asc" ]],
            aLengthMenu: [100, 200, 500],
            "columnDefs": [
              { "render": function ( data ) { return data.toFixed(3); }, "targets": [4, 5, 6] },
              { "render": function ( data, type, row ) { 
                return '<a class="btn btn-xs btn-link" data-toggle="collapse" href="#tr' + row[0] + '" aria-controls="tr' + row[0] + '">Show/hide</a><div class="collapse" id="tr' + row[0] + '">' + data.map(function(x) { return x.toFixed(3); }).join("<br/>") + '</div>';
              }, "targets": [3] },
              { "render": function ( data, type, row ) { return sin_render_substance_small(row[0], data); }, "targets": [1, 2] },
              { "render": function ( data, type, row ) { 
                return sin_render_jobresult(job_id + "/" + row[0]);
              }, "targets": [7] },
              // { "visible": false,  "targets": [ 0, 2, 4, 6 ] },
            ],
            "fnDrawCallback": function( oSettings ) {
              $(".fancybox-ajax").fancybox({type : "image"});
              $(".btn-mz").click(show_images_callback);
            }
          } );
        } );
        $("#filterform").submit( function( event ) {
          event.preventDefault();
          table = $('#table-images').dataTable();
          oSettings = table.fnSettings();
          table.fnClearTable(this);
          // alert(val_maxent);
          set_filter();
          // alert('!');
          // alert(val_maxent);
          // alert($('#maxEntropy').val());
          for (var i=0; i<tbl_data.length; i++) {
            // alert(tbl_data[i][4]);
            // alert(filter_row(tbl_data[i]));
            if (filter_row(tbl_data[i])) {
              table.oApi._fnAddData(oSettings, tbl_data[i]);
            }
          }
          oSettings.aiDisplay = oSettings.aiDisplayMaster.slice();
          table.fnDraw();
        });
      } );
{% end %}

{% block body %}
  <div class="container">
    <div class="row">
    <div class="col-xs-6">
      <div class="page-header">
        <div class="row">
          <h2 id="about-name">Name</h2>
        </div>
        <div class="row">
          <h3 id="about-dataset">Dataset</h3>
        </div>
      </div>
    </div>
    <div class="col-xs-6">
      <div class="panel panel-primary">
        <div class="panel-heading">Filters</div>
        <div class="panel-body">
          <form class="form-horizontal" id="filterform">
            <div class="container-fluid">
                <!--p> Here you can set the filters and view filtered results.</p-->
                <!--p style="font-size:10pt;" id="sel1"></p-->
                <div class="form-group form-group-sm">
                    <label class="control-label col-lg-1"><input id="useMaxEntropy" type="checkbox"></label>
                    <label for="maxEntropy" class="control-label col-lg-7">Entropy &le;</label>
                    <div class="col-lg-4">
                          <input type="number" pattern="[0-9]+([\.|,][0-9]+)?" step="0.001" value="0.200" class="form-control" id="maxEntropy" disabled>
                    </div>
                </div>
                <div class="form-group form-group-sm">
                    <label class="control-label col-lg-1"><input id="useMinCorrIsotope" type="checkbox"></label>
                    <label for="minCorrIsotope" class="control-label col-lg-7">Correlation with peak intensities &ge;</label>
                    <div class="col-lg-4">
                        <input type="number" pattern="[0-9]+([\.|,][0-9]+)?" step="0.001" value="0.900" class="form-control" id="minCorrIsotope" disabled>
                    </div>
                </div>
                <div class="form-group form-group-sm">
                    <label class="control-label col-lg-1"><input id="useMinCorrImages" type="checkbox"></label>
                    <label for="minCorrImages" class="control-label col-lg-7">Avg. correlation with monoisotopic &ge;</label>
                    <div class="col-lg-4">
                        <input type="number" pattern="[0-9]+([\.|,][0-9]+)?" step="0.001" value="0.900" class="form-control" id="minCorrImages" disabled>
                    </div>
                </div>
                <div class="form-group form-group-sm">
                    <div class="col-lg-offset-8 col-lg-4">
                        <button type="submit" class="btn btn-primary">Filter</button>
                    </div>
                </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    </div>

    <div class="panel panel-primary">
      <div class="panel-heading">Individual images</div>
      <table id="table-images" class="table table-striped" cellspacing="0" width="100%">
        <thead>
          <tr>
            <th>Substance id</th>
            <th>Substance</th>
            <th>Formula</th>
            <th>Image entropies</th>
            <th>Average entropy</th>
            <th>Average image correlation with monoisotopic</th>
            <th>Image intensity correlation with peak intensities</th>
            <th></th>
          </tr>
        </thead>
   
        <tfoot>
          <tr>
            <th>Substance id</th>
            <th>Substance</th>
            <th>Formula</th>
            <th>Image entropies</th>
            <th>Average entropy</th>
            <th>Average image correlation with monoisotopic</th>
            <th>Image intensity correlation with peak intensities</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
{% end %}

{% block modals %}
 <div class="modal fade" id="mzmodal">
  <div class="modal-dialog" style="width:80%;">
    <div class="modal-content"><div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
      <h4 class="modal-title">m/z images</h4>
    </div>
    <div class="modal-body">
      <p>The images below correspond to individual isotope peaks. Image entropies are shown below the images.</p>
      <div id="mz-body">
      </div>
    </div>
  </div>
{% end %}


