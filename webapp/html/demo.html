{% extends "main.html" %}

{% block add_includes %}
    <link rel="stylesheet" href="{{ static_url("js/fancybox/source/jquery.fancybox.css") }}" type="text/css" media="screen" />
    <link rel="stylesheet" href="{{ static_url("css/jquery.dataTables.yadcf.css") }}" type="text/css" media="screen" />
    <script type="text/javascript" src="{{ static_url("js/fancybox/source/jquery.fancybox.pack.js") }}" ></script>

    <!-- AmCharts -->
    <script src="{{ static_url("js/d3.min.js") }}"></script>
    <script src="{{ static_url("js/amcharts/amcharts.js") }}"></script>
    <script src="{{ static_url("js/amcharts/serial.js") }}"></script>
    
    <script src="{{ static_url("js/jquery.dataTables.columnFilter.js") }}"></script>
    <script src="{{ static_url("js/fnGetAdjacentTr.js") }}"></script>
    <script src="{{ static_url("js/jquery.dataTables.yadcf.js") }}"></script>
{% end %}

{% block init_script %}
    <script type="text/javascript" class="init">
      $(document).ready(function() {
          $("#nav-demo").addClass("active");
          $("#nav-demo a").attr("href", "#");
          $("#nav-demo a").html( $("#nav-demo a").html() + ' <span class="sr-only">(current)</span>' );
        var array_adducts = ['H', 'Na', 'K'];

        var max_peaks_to_show = 6;
        var mz_array = [];

        var res_datasetids = [];
        var res_datasets = [];
        var res_alldatasets = [];
        var res_stats = [];
        var res_jobids = [];
        var tbl_demo;
        var current_dataset = -1;

        function set_dataset(id) {
          current_dataset = id;
          var j = 0;
          for (; j < res_datasetids.length; j++) {
            if (res_datasetids[j] == id) {
              break;
            }
          }
          $("#img-body").empty();
          if (j < res_datasetids.length) {
            $("#img-header").text("Images and statistics for dataset " + res_datasets[j]);
            $("#img-body").append('<div class="row"><div class="col-lg-8" style="text-align:right;">Average correlation with the monoisotopic (first) image:</div><div class="col-lg-4"><b><span id="span-corriso"></span></b></div></div><div class="row"><div class="col-lg-8" style="text-align:right;">Correlation with peak intensities:</div><div class="col-lg-4"><b><span id="span-corrint"></span></b></div></div><div class="row"><div class="col-lg-8" style="text-align:right;">Mean entropy:</div><div class="col-lg-4"><b><span id="span-meanent"></span></b></div></div><table id="tbl-images" width="100%"></table>');
            $("#span-corriso").text(res_stats[j]["corr_images"].toFixed(4));
            $("#span-corrint").text(res_stats[j]["corr_int"].toFixed(4));
            $("#span-meanent").text(res_stats[j]["mean_ent"].toFixed(4));
            $("#tbl-images").empty();
            $("#tbl-images").append('<tr id="tr-images"></tr>');
            for (var k=0; k < res_stats[j]["entropies"].length; k++) {
              $("#tr-images").append('<td><img width="100%" src="/mzimage/' + res_jobids[j] + 'p' + k + '.png"/></td>');
            }
            $("#tbl-images").append('<tr id="tr-imageent"></tr>');
            for (var k=0; k < res_stats[j]["entropies"].length; k++) {
              $("#tr-imageent").append('<td style="text-align:center;">Entropy: <b>' + res_stats[j]["entropies"][k].toFixed(3) + '</b></td>');
            }
          } else {
            $("#img-header").text("Run m/z extraction for dataset " + res_alldatasets[id]);
            $("#img-body").append('<div class="row"><div class="col-md-8">When you press this button, a Spark job will be initiated at the server side. It will appear in the list (updated every 5 seconds). When it finishes, <b>reload the page</b> to view the m/z image.</div><div class="col-md-4"><div class="pull-right"><button id="btn-runmz" class="btn btn-large btn-primary" type="button">Run m/z extraction for dataset ' + res_alldatasets[id] + '</button></div></div></div>');
            $('#btn-runmz').click(function() {
              $('#btn-runmz').addClass("disabled");
              // alert(mz_array_forspark.toString());
              $.post("/run/extractmzs", {
                "data" : mz_array_forspark.toString(),
                "formula_id" : subst_id,
                "dataset_id" : current_dataset
              });
            });
          }
        }

        $(".fancybox").fancybox();

        function select_row(row_object) {
            /*
             * Measuring total time for select_row.
             */
            var t_total_start = performance.now();
            $(row_object).addClass('selected');
            var d = tbl_demo.row(row_object).data();
            var dataset_id = d[11];
            var sf_id = d[12];
            var subst_id = d[4];
            var entropies = d[10];
            // var colors = ["white", "red"];
            var colors = ['#352A87', '#0268E1', '#108ED2', '#0FAEB9', '#65BE86', '#C0BC60', '#FFC337', '#F9FB0E'];

            var pixel_size = 4;

            $("#imagediv").empty();
            $("#imagediv").html("<h4 style='text-align:center'>...loading images...</h4>");
            $("#ionimage_total").empty();
            $("#ionimage_total").html("<h4 style='text-align:center'>...loading image...</h4>");
            $("#ionimage_total_cb").empty();

            var t_getJson_start = performance.now();
            $.getJSON("/ajax/demosubst/" + d[9].toString() + "/" + sf_id + "/" + d[2] + "/" + dataset_id + "/", function (data) {
              var t_getJsonBody_start = performance.now();
              console.log(data);
              var num_adducts = data["data"].length;
              var max_x = 0;
              var max_y = 0;
              for (var k in data["coords"]) {
                if (data["coords"][k][0] > max_x) {
                  max_x = data["coords"][k][0];
                }
                if (data["coords"][k][1] > max_y) {
                  max_y = data["coords"][k][1];
                }
              }
              $("#imagediv").empty();

              // console.log(data["spadd"]);
              var data_dict = {};
              var adduct_peak_ints = {};
              for (var iAdd in data["data"]) {
                adduct_peak_ints[iAdd] = [];
                for (var imInd = 0; imInd < data["data"][iAdd].length; imInd++) {
                  adduct_peak_ints[iAdd].push(0);
                  for (var sp in data["data"][iAdd][imInd]["sp"]) {
                    adduct_peak_ints[iAdd][imInd] += data["data"][iAdd][imInd]["val"][sp];
                    if (!(data["data"][iAdd][imInd]["sp"][sp] in data_dict)) {
                      data_dict[data["data"][iAdd][imInd]["sp"][sp]] = data["data"][iAdd][imInd]["val"][sp];
                    } else {
                      data_dict[data["data"][iAdd][imInd]["sp"][sp]] += data["data"][iAdd][imInd]["val"][sp];
                    }
                  }
                }
              }
              for (var iAdd in data["data"]) {
                var first_element = adduct_peak_ints[iAdd][0];
                for (var imInd = 0; imInd < adduct_peak_ints[iAdd].length; imInd++) {
                  adduct_peak_ints[iAdd][imInd] = 100.0 * adduct_peak_ints[iAdd][imInd] / first_element;
                }
              }

              var mz_array = [];
              for (var i=0; i < data["spec"]["isodist_mzs"].length; i++) {
                var cur = { "mz" : data["spec"]["isodist_mzs"][i].toFixed(3),
                            "int" : data["spec"]["isodist_int"][i].toFixed(3) };
                mz_array.push(cur);
              }
              // console.log(mz_array);
              data_arrs = {"sp" : [], "val" : []};
              for (var sp in data_dict) {
                data_arrs["sp"].push(parseInt(sp, 10));
                data_arrs["val"].push(data_dict[sp]);
              }
              $("#ionimage_total").empty();
              $("#ionimage_total").attr("align", "center");

              /*
               * Measuring time for rendering total ion image.
               */
            //   var start = new Date().getTime();
              var t_start = performance.now();
              var ionimage_scale = sin_render_ionimage("#ionimage_total", data_arrs, data["coords"], pixel_size, colors, max_x, max_y);
              var t_end = performance.now();
            //   var time_delta = new Date().getTime() - start;
              console.log("Rendering ionimage_total took " + (t_end - t_start) + "ms.");

              /*
               * Measuring time for rendering horizontal color bar.
               */
              var t_start = performance.now();
              sin_render_colorbar_horiz("#ionimage_total_cb", ionimage_scale);
              var t_end = performance.now();
              console.log("Rendering color bar took " + (t_end - t_start) + "ms.")

              /*
               * Measuring time for adduct-specific computation.
               */
              var t_start = performance.now();
              var add_mzarrays = {}
              for (var iAdd in data["data"]) {
                var num_peaks = Math.min(data["data"][iAdd].length, max_peaks_to_show);
                var w_percent = 100 / num_peaks;
                var col_w = Math.floor(12 / num_peaks);
                $("#imagediv").append('<div class="row"><div class="col-lg-3"><h3>+' + iAdd + '</h3></div></div><div class="row" id="row-images-' + iAdd + '"></div><div class="row"><div id="molchart_' + iAdd + '"></div></div>');
                for (var imInd=0; imInd < num_peaks; imInd++) {
                  // console.log(data["data"][iAdd][imInd]);
                  to_append = '<div style="text-align:center;" class="col-lg-' + col_w.toString() + '">'
            		    + '<div class="container-fluid">'
                    + '<div class="row"><b>'
                    + data["spadd"][iAdd]["grad_mzs"][imInd].toFixed(3) + '</b></div>'
                    + '<div class="row" id="col-img-' + iAdd + '-' + imInd.toString() + '"></div>'
                    + '<div class="row">';
                  if (imInd == 0) {
                    to_append += '<div class="col-lg-8">Spatial presence</div><div class="col-lg-4">';
                  } else {
                    to_append += '<div class="col-lg-12">';
                  }
                  to_append += data["data"][iAdd][imInd]["entropy"].toFixed(3) + '</div></div></div>';
                  $('#row-images-' + iAdd).append(to_append);
                  sin_render_ionimage("#col-img-" + iAdd + "-" + imInd.toString(), data["data"][iAdd][imInd], data["coords"], pixel_size, colors, max_x, max_y);
                }
                add_mzarrays[iAdd] = [];
                var curGuides = [];
                var curPeak = 0;
                var cur = { "mz" : (data["spadd"][iAdd]["isodist_mzs"][0]-0.25).toFixed(3),
                              "int" : (0).toFixed(3),
                              "sample" : (0).toFixed(3) };
                add_mzarrays[iAdd].push(cur);
                for (var i=0; i < data["spadd"][iAdd]["isodist_mzs"].length; i++) {
                  cur_mz = data["spadd"][iAdd]["isodist_mzs"][i];
                  var cur = { "mz" : cur_mz.toFixed(3),
                              "int" : data["spadd"][iAdd]["isodist_int"][i].toFixed(3),
                              "sample" : (0).toFixed(3) };
                  if ( data["spadd"][iAdd]["grad_mzs"][curPeak] == cur_mz ) {
                    cur["sample"] = adduct_peak_ints[iAdd][curPeak].toFixed(3);
                    cur["bullet"] = "round";
                    curPeak++;
                    curGuides.push({
                      "category" : cur_mz.toFixed(3),
                      "boldLabel" : "True",
                      "color" : "black",
                      "dashLength" : 5,
                      "lineAlpha" : 1,
                      "label" : cur_mz.toFixed(3),
                    });
                  }
                  add_mzarrays[iAdd].push(cur);
                }
                var cur = { "mz" : (cur_mz+0.25).toFixed(3),
                              "int" : (0).toFixed(3),
                              "sample" : (0).toFixed(3) };
                add_mzarrays[iAdd].push(cur);
                // console.log(curGuides);
                $("#molchart_" + iAdd).attr("style", "width: 100%; height: 200px;");
                // console.log(add_mzarrays[iAdd]);
                var newchart = sin_amchart_spectrum_withsample("molchart_" + iAdd,
                  add_mzarrays[iAdd],
                  curGuides,
                  '{{ static_url("js/amcharts/images/") }}');
              }
              var t_end = performance.now();
              console.log("Adduct-specific computations took " + (t_end - t_start) + "ms.");
              console.log("Time for getJSON body: " + (t_end - t_getJsonBody_start) + "ms.");
              console.log("Time for getJSON overall: " + (t_end - t_getJson_start) + "ms.");
              console.log("Total time for select_row: " + (t_end - t_total_start) + "ms.");
            });

            $("#about-name").html( sin_render_sf(d[2]) );
            var asf_html = '';
            for (var i = 0; i < d[3].length; i++) {
              asf_html += '<div class="col-md-1"><h5>' + d[4][i] + '</h5></div>';
              asf_html += '<div class="col-md-3" style="word-wrap: break-word;"><h4>' + d[3][i] + '</h4></div>';
              asf_html += '<div class="col-md-2"><a class="fancybox" rel="group" href="http://moldb.wishartlab.com/molecules/HMDB'
                + d[4][i].toString()
                + '/image.png"><img height="80" src="http://moldb.wishartlab.com/molecules/HMDB'
                + d[4][i].toString()
                + '/thumb.png" alt="" /></a></div>';
              if (i % 2 == 1) {
                asf_html += '</div><div class="row">'
              }
            }
            $("#about-sf").html( '<div class="row">' + asf_html + '</div>' );
        }

        tbl_demo = $('#table-demo').DataTable( {
          ajax: "/ajax/demobigtable/",
          scrollY: "200px",
          dom: "rtiS",
          deferRender: true,
          processing: true,
          serverSide: false,
          paging:     false,
          bSortCellsTop: true,
          bSearchable: false,
          bStateSave: true,
          order: [[ 7, "desc" ]],
          "columnDefs": [
            { "render": function ( data, type, row ) {
              if (type === 'display') {
                return sin_render_sf(data);
              } else {
                return data;
              }
            }, "targets": [2] },
            { "render": function ( data, type, row ) {
              if (type === 'filter' || type === 'sort') {
                return data.join(" ");
              }
              if (data.length == 1) {
                return sin_render_substance_small(row[4][0], data[0]);
              }
              res = '<span style="margin:0 0px;" rel="tooltip" data-html="true" title="'
                + data.join("<br/>").replace(/"/g, '\\"')
                + '">' + data.length.toString() + ' metabolite';
              if (data.length > 1) {
                res += 's';
              }
              return res + '</span>';
            }, "targets": [3] },
            { "render": function ( data, type, row ) {
              if (type === 'filter' || type === 'sort') {
                return data.join(" ");
              }
              if (data.length == 1) {
                return sin_render_substance_small(row[4][0], data[0]);
              }
              res = '<span style="margin:0 0px;" rel="tooltip" data-html="true" title="'
                + data.join("<br/>").replace(/"/g, '\\"')
                + '">' + data.length.toString() + ' id';
              if (data.length > 1) {
                res += 's';
              }
              return res + '</span>';
            }, "targets": [4] },
            { "render": function ( data, type, row ) {
              // console.log(data);
              return d3.max(data);
            }, "targets": [5, 6, 7] },
            { "render": function ( data, type, row ) {
              return data.sort().map(function(d) { return array_adducts[d]; }).join(" ");
            }, "targets": [8] },
            { "visible": false,  "targets": [ 9, 10, 11, 12 ] },
          ],
          "initComplete" : function(oSettings, json) {
            $('#table-demo').tooltip({
              selector: "span[rel=tooltip]",
              html: true
            });
          }
        } );
        
        yadcf.init(tbl_demo, [
          {column_number : 0, filter_type: "select", filter_container_id: "fil-db", filter_reset_button_text: false, filter_default_label: 'Select...'},
          {column_number : 1, filter_type: "select", filter_container_id: "fil-ds", filter_reset_button_text: false, filter_default_label: 'Select...'},
          {column_number : 2, filter_type: "text", filter_container_id: "fil-nm", filter_reset_button_text: false },
          {column_number : 3, filter_type: "text", filter_container_id: "fil-sf", filter_reset_button_text: false},
          {column_number : 4, filter_type: "text", filter_container_id: "fil-id", filter_reset_button_text: false},
          {column_number : 5, filter_type: "lower_bound_number", filter_container_id: "fil-sp",
            filter_reset_button_text: false, filter_default_label: ['&ge;']
          },
          {column_number : 6, filter_type: "lower_bound_number", filter_container_id: "fil-ic", filter_reset_button_text: false, filter_default_label: ['&ge;'] },
          {column_number : 7, filter_type: "lower_bound_number", filter_container_id: "fil-sc", filter_reset_button_text: false, filter_default_label: ['&ge;']},
          {column_number : 8, filter_type: "select", filter_container_id: "fil-ad", filter_reset_button_text: false, filter_default_label: 'all'},
          // {column_number : 7, filter_type: "range_number", filter_container_id: "fil-jb", filter_reset_button_text: false},
        ]);

        $('#table-demo tbody').on( 'click', 'tr', function () {
          if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
          }
          else {
            tbl_demo.$('tr.selected').removeClass('selected');
            select_row(this);
          }
        } );

        function handleKeyPress(e){
          var keycode;
          if (window.event) keycode = window.event.keyCode;
          else if (e) keycode = e.which;
          var direction = (keycode==38)?-1:(keycode==40)?1:0;
          if (direction != 0 && $('#table-demo tbody tr').hasClass('selected')){
            var tbl_demo_my = $("#table-demo").dataTable();
            var cur = tbl_demo_my.$('#table-demo tbody tr.selected');
            var next = tbl_demo_my.fnGetAdjacentTr( cur[0], (direction == 1) );
            cur.removeClass('selected');
            select_row(next);
          }
        }

        document.onkeydown = handleKeyPress;

      } );
{% end %}

{% block body %}
    <div class="panel panel-primary">
      <div class="panel-heading">Results overview</div>
      <table id="table-demo" class="table table-striped" cellspacing="0" width="100%">
        <thead>
          <tr>
            <th>Database</th>
            <th>Dataset</th>
            <th>Molecular formula</th>
            <th width="200">Name</th>
            <th>Database ID</th>
            <th>Spatial presence</th>
            <th>Image correlation</th>
            <th>Spectral correlation</th>
            <th>Adduct</th>
            <th>Job id</th>
            <th>Entropies</th>
            <th>Dataset id</th>
            <th>SF id</th>
          </tr>
          <tr>
            <th id="fil-db"></th>
            <th id="fil-ds"></th>
            <th id="fil-nm"></th>
            <th id="fil-sf"></th>
            <th id="fil-id"></th>
            <th id="fil-sp"></th>
            <th id="fil-ic"></th>
            <th id="fil-sc"></th>
            <th id="fil-ad"></th>
            <th></th><th></th><th></th><th></th>
          </tr>
        </thead>
   
        <!--tfoot>
          <tr>
            <th>Database</th>
            <th>Dataset</th>
            <th>Molecular formula</th>
            <th>Name</th>
            <th>Database ID</th>
            <th>Spatial presence</th>
            <th>Image correlation</th>
            <th>Spectral correlation</th>
            <th>Adduct</th>
            <th>Job id</th>
            <th>Entropies</th>
            <th>Dataset id</th>
            <th>SF id</th>
          </tr>
        </tfoot-->
      </table>
    </div>

    <div class="row">
      <div class="col-md-9">
        <div class="container-fluid">
          <div class="page-header">
            <div class="row" style="text-align=center;">
              <h2 id="about-name"></h2>
            </div>
            <div class="row" id="about-sf">
            </div>
            <div class="row">
              <div id="molecular_chart"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="container-fluid">
          <div class="row">
            <div id="ionimage_total"></div>
          </div>
          <div class="row">
            <div id="ionimage_total_cb"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="imagediv">
    </div>


  </div>
{% end %}


{% block modals %}
 <div class="modal fade" id="mzmodal">
  <div class="modal-dialog" style="width:80%;">
    <div class="modal-content"><div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
      <h4 class="modal-title">m/z images</h4>
    </div>
    <div class="modal-body">
      <div class="row">
        <div class="col-lg-8" style="text-align:right;">Average correlation with the monoisotopic (first) image:</div>
        <div class="col-lg-4"><span id="span-corriso"></span></div>
      </div>
      <div class="row">
        <div class="col-lg-8" style="text-align:right;">Correlation with peak intensities:</div>
        <div class="col-lg-4"><span id="span-corrint"></span></div>
      </div>
      <p>The images below correspond to individual isotope peaks. Image entropies are shown below the images.</p>
      <div id="mz-body">
      </div>
    </div>
  </div>
{% end %}

